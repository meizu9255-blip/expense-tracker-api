<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qarjy Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* –ê–ù–ò–ú–ê–¶–ò–Ø */
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-up { animation: slideUp 0.6s ease-out forwards; }
        
        /* –î–ò–ó–ê–ô–ù */
        body { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); color: #fff; font-family: 'Segoe UI', sans-serif; min-height: 100vh; }
        
        /* –ü–ê–ù–ï–õ–¨–î–ï–† */
        .custom-panel, .stat-card {
            background: #111827; border: 1px solid #1f2937; border-radius: 20px; padding: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .form-control, .form-select {
            background-color: #1f2937 !important; border: 1px solid #374151; color: white !important;
            border-radius: 10px; padding: 12px;
        }
        .form-control:focus { border-color: #3b82f6; box-shadow: none; }

        /* –ë–ê–¢–´–†–ú–ê–õ–ê–† */
        .btn-add {
            background: #3b82f6; border: none; width: 100%; padding: 12px; border-radius: 10px;
            font-weight: bold; transition: 0.3s; color: white;
        }
        .btn-add:hover { background: #2563eb; transform: translateY(-2px); }
        
        /* TOGGLE */
        .type-toggle { display: flex; gap: 10px; margin-bottom: 20px; background: #1f2937; padding: 5px; border-radius: 12px; }
        .type-btn {
            flex: 1; padding: 10px; border: none; border-radius: 8px; background: transparent;
            color: #9ca3af; font-weight: bold; transition: 0.3s;
        }
        .active-expense { background: #ef4444; color: white; }
        .active-income { background: #10b981; color: white; }

        /* –°–¢–ê–¢–ò–°–¢–ò–ö–ê */
        .card-green h3 { color: #10b981; } .card-red h3 { color: #ef4444; } .card-blue h3 { color: #3b82f6; }
        
        /* LOGIN */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #020617; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        
        /* –¢–Ü–ó–Ü–ú */
        .tx-item { background: #1f2937; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #374151; }
    </style>
</head>
<body>

    <div id="login-section" class="login-overlay">
        <div class="custom-panel text-center animate-up" style="width: 400px;">
            <div class="mb-4"><i class="fas fa-wallet fa-3x text-primary"></i></div>
            <h3 class="fw-bold mb-4" id="auth-title">–ñ“Ø–π–µ–≥–µ –∫—ñ—Ä—É</h3>
            
            <div id="reg-name-div" style="display:none;">
                <input type="text" id="reg-name" class="form-control mb-3" placeholder="–ê—Ç—ã“£—ã–∑">
            </div>
            <input type="email" id="email" class="form-control mb-3" placeholder="Email" value="admin@test.kz">
            <input type="password" id="password" class="form-control mb-4" placeholder="–ü–∞—Ä–æ–ª—å" value="123">
            
            <button onclick="handleAuth()" class="btn-add mb-3" id="auth-btn">–ö—ñ—Ä—É</button>
            
            <p class="small text-secondary" style="cursor:pointer" onclick="toggleAuth()">
                <span id="auth-switch">–ê–∫–∫–∞—É–Ω—Ç—ã“£—ã–∑ –∂–æ“õ –ø–∞? –¢—ñ—Ä–∫–µ–ª—É</span>
            </p>
        </div>
    </div>

    <div id="dashboard-section" class="container-fluid p-4" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4 animate-up">
            <div class="d-flex align-items-center gap-3">
                <i class="fas fa-chart-pie fa-2x text-primary"></i>
                <div>
                    <h4 class="m-0 fw-bold">–¢”©–ª–µ–º–¥–µ—Ä –º–µ–Ω –®—ã“ì—ã–Ω–¥–∞—Ä</h4>
                    <small class="text-secondary">“ö–∞—Ä–∂—ã–ª—ã“õ –±–∞“õ—ã–ª–∞—É</small>
                </div>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="text-end d-none d-md-block">
                    <div class="fw-bold" id="user-name">User</div>
                    <div class="small text-secondary" id="user-email">...</div>
                </div>
                <button onclick="logout()" class="btn btn-outline-danger btn-sm">–®—ã“ì—É</button>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-4 animate-up delay-1">
                <div class="custom-panel h-100">
                    <h5 class="mb-4">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è “õ–æ—Å—É</h5>
                    <div class="type-toggle">
                        <button id="btn-expense" class="type-btn active-expense" onclick="setType('expense')">–®—ã“ì—ã–Ω</button>
                        <button id="btn-income" class="type-btn" onclick="setType('income')">–¢”©–ª–µ–º</button>
                    </div>
                    
                    <label class="small text-secondary mb-1">–°–æ–º–∞</label>
                    <input type="number" id="amount" class="form-control mb-3" placeholder="0">
                    
                    <div id="cat-wrapper">
                        <label class="small text-secondary mb-1">–°–∞–Ω–∞—Ç</label>
                        <select id="cat-id" class="form-select mb-3">
                            <option value="1">üçî –¢–∞–º–∞“õ</option>
                            <option value="2">üöå –ö”©–ª—ñ–∫</option>
                            <option value="3">üõçÔ∏è –°–∞—Ç—ã–ø –∞–ª—É</option>
                            <option value="5">üí° –ö–æ–º–º—É–Ω–∞–ª–¥—ã“õ</option>
                            <option value="9">üì¶ –ë–∞—Å“õ–∞</option>
                        </select>
                    </div>
                    
                    <label class="small text-secondary mb-1">–ö“Ø–Ω—ñ</label>
                    <input type="date" id="date" class="form-control mb-3">
                    
                    <label class="small text-secondary mb-1">–°–∏–ø–∞—Ç—Ç–∞–º–∞</label>
                    <textarea id="desc" class="form-control mb-3" rows="2" placeholder="..."></textarea>
                    
                    <button onclick="addTransaction()" class="btn-add">“ö–æ—Å—É</button>
                </div>
            </div>

            <div class="col-lg-8 animate-up delay-2">
                <div class="row g-3 mb-4">
                    <div class="col-md-4"><div class="stat-card card-green"><small>–¢”©–ª–µ–º–¥–µ—Ä</small><h3 id="inc-total">0 ‚Ç∏</h3></div></div>
                    <div class="col-md-4"><div class="stat-card card-red"><small>–®—ã“ì—ã–Ω–¥–∞—Ä</small><h3 id="exp-total">0 ‚Ç∏</h3></div></div>
                    <div class="col-md-4"><div class="stat-card card-blue"><small>–ë–∞–ª–∞–Ω—Å</small><h3 id="net-total">0 ‚Ç∏</h3></div></div>
                </div>

                <div class="custom-panel mb-4">
                    <h5 class="mb-3">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–¢”©–ª–µ–º vs –®—ã“ì—ã—Å)</h5>
                    <div style="height: 250px;"><canvas id="barChart"></canvas></div>
                </div>
                
                <div class="custom-panel">
                    <h5 class="mb-3">–°–æ“£“ì—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–ª–∞—Ä</h5>
                    <div id="tx-list" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://expense-tracker-api-iy65.onrender.com";
        let token = localStorage.getItem("access_token");
        let currentType = 'expense';
        let isLogin = true;

        document.getElementById('date').valueAsDate = new Date();
        if (token) showDashboard();

        function setType(t) {
            currentType = t;
            if(t==='expense') {
                document.getElementById('btn-expense').className = 'type-btn active-expense';
                document.getElementById('btn-income').className = 'type-btn';
                document.getElementById('cat-wrapper').style.display = 'block';
            } else {
                document.getElementById('btn-income').className = 'type-btn active-income';
                document.getElementById('btn-expense').className = 'type-btn';
                document.getElementById('cat-wrapper').style.display = 'none';
            }
        }

        function toggleAuth() {
            isLogin = !isLogin;
            document.getElementById('auth-title').innerText = isLogin ? "–ñ“Ø–π–µ–≥–µ –∫—ñ—Ä—É" : "–¢—ñ—Ä–∫–µ–ª—É";
            document.getElementById('auth-btn').innerText = isLogin ? "–ö—ñ—Ä—É" : "–¢—ñ—Ä–∫–µ–ª—É";
            document.getElementById('auth-switch').innerText = isLogin ? "–ê–∫–∫–∞—É–Ω—Ç—ã“£—ã–∑ –∂–æ“õ –ø–∞? –¢—ñ—Ä–∫–µ–ª—É" : "–ê–∫–∫–∞—É–Ω—Ç—ã“£—ã–∑ –±–∞—Ä –º–∞? –ö—ñ—Ä—É";
            document.getElementById('reg-name-div').style.display = isLogin ? "none" : "block";
        }

        async function handleAuth() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const btn = document.getElementById("auth-btn");
            btn.innerText = "–ö“Ø—Ç–µ —Ç“±—Ä—ã“£—ã–∑...";

            try {
                if (isLogin) {
                    const fd = new FormData(); fd.append("username", email); fd.append("password", password);
                    const res = await fetch(`${API_URL}/token`, { method: "POST", body: fd });
                    if (!res.ok) throw new Error();
                    const data = await res.json();
                    localStorage.setItem("access_token", data.access_token);
                    token = data.access_token;
                    showDashboard();
                } else {
                    const username = document.getElementById("reg-name").value;
                    const res = await fetch(`${API_URL}/users/`, { 
                        method: "POST", headers: {"Content-Type":"application/json"}, 
                        body: JSON.stringify({username, email, password}) 
                    });
                    if (res.ok) { alert("–¢—ñ—Ä–∫–µ–ª–¥—ñ! –ï–Ω–¥—ñ –∫—ñ—Ä—ñ“£—ñ–∑."); toggleAuth(); }
                    else { alert("–¢—ñ—Ä–∫–µ–ª—É “õ–∞—Ç–µ—Å—ñ!"); }
                }
            } catch { alert("–°–µ—Ä–≤–µ—Ä “õ–∞—Ç–µ—Å—ñ! (–°–µ—Ä–≤–µ—Ä –æ—è–Ω—ã–ø –∂–∞—Ç“õ–∞–Ω —à—ã“ì–∞—Ä)"); }
            btn.innerText = isLogin ? "–ö—ñ—Ä—É" : "–¢—ñ—Ä–∫–µ–ª—É";
        }

        function logout() { localStorage.removeItem("access_token"); location.reload(); }
        function showDashboard() { 
            document.getElementById('login-section').style.display='none'; 
            document.getElementById('dashboard-section').style.display='block';
            loadData();
            fetch(`${API_URL}/users/me/`, { headers: {"Authorization": `Bearer ${token}`} })
                .then(r => r.json()).then(u => {
                    document.getElementById("user-name").innerText = u.username;
                    document.getElementById("user-email").innerText = u.email;
                });
        }

        async function loadData() {
            const headers = { "Authorization": `Bearer ${token}` };
            // –ë–∞–ª–∞–Ω—Å
            const resBal = await fetch(`${API_URL}/balance/`, { headers });
            const bal = await resBal.json();
            document.getElementById("inc-total").innerText = bal.total_income + " ‚Ç∏";
            document.getElementById("exp-total").innerText = bal.total_expenses + " ‚Ç∏";
            document.getElementById("net-total").innerText = bal.net_balance + " ‚Ç∏";

            // –¢—ñ–∑—ñ–º –∂”ô–Ω–µ –ì—Ä–∞—Ñ–∏–∫
            const [r1, r2] = await Promise.all([
                fetch(`${API_URL}/expenses/`, { headers }),
                fetch(`${API_URL}/incomes/`, { headers })
            ]);
            const exp = await r1.json();
            const inc = await r2.json();
            
            const all = [...exp.map(x=>({...x, type:'exp'})), ...inc.map(x=>({...x, type:'inc'}))];
            all.sort((a,b) => new Date(b.date) - new Date(a.date));
            
            renderList(all);
            drawChart(bal.total_income, bal.total_expenses);
        }

        async function addTransaction() {
            const amt = document.getElementById("amount").value;
            if(!amt) return alert("–°–æ–º–∞–Ω—ã –∂–∞–∑—ã“£—ã–∑!");
            
            const body = {
                amount: parseFloat(amt),
                description: document.getElementById("desc").value,
                date: document.getElementById("date").value
            };
            if(currentType === 'expense') body.category_id = parseInt(document.getElementById("cat-id").value);

            const res = await fetch(`${API_URL}/${currentType}s/`, {
                method: "POST",
                headers: {"Authorization": `Bearer ${token}`, "Content-Type": "application/json"},
                body: JSON.stringify(body)
            });

            if(res.ok) {
                alert("–°”ô—Ç—Ç—ñ “õ–æ—Å—ã–ª–¥—ã!");
                document.getElementById("amount").value = "";
                loadData();
            } else {
                const err = await res.json();
                alert("“ö–∞—Ç–µ: " + JSON.stringify(err.detail));
            }
        }

        function renderList(data) {
            const list = document.getElementById("tx-list");
            list.innerHTML = "";
            data.forEach(i => {
                const isExp = i.type === 'exp';
                list.innerHTML += `
                    <div class="tx-item">
                        <div>
                            <strong class="${isExp?'text-red':'text-green'}">${isExp ? '–®—ã“ì—ã–Ω' : '–¢”©–ª–µ–º'}</strong>
                            <small class="text-secondary d-block">${i.description || '-'} | ${i.date.split('T')[0]}</small>
                        </div>
                        <div class="fw-bold">${isExp?'-':'+'} ${i.amount} ‚Ç∏</div>
                    </div>`;
            });
        }

        function drawChart(inc, exp) {
            const ctx = document.getElementById('barChart');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['–¢”©–ª–µ–º', '–®—ã“ì—ã—Å'],
                    datasets: [{
                        data: [inc, exp],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderRadius: 10
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }
    </script>
</body>
</html>