<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qarjy Pro - FINAL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background: linear-gradient(135deg, #0f172a 0%, #172554 100%); color: #ffffff; font-family: sans-serif; min-height: 100vh; }
        .custom-panel, .stat-card { background: #111827; border: 1px solid #1f2937; border-radius: 20px; padding: 24px; }
        .form-control, .form-select { background-color: #1f2937 !important; border: 1px solid #374151; color: white !important; border-radius: 10px; padding: 12px; }
        .btn-add { background: #2563eb; color: white; width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; margin-top: 10px; }
        .type-toggle { display: flex; gap: 10px; margin-bottom: 20px; }
        .type-btn { flex: 1; padding: 10px; border-radius: 8px; background: #1f2937; color: #9ca3af; border: none; }
        .active-expense { background: #ef4444; color: white; }
        .active-income { background: #10b981; color: white; }
        .stat-card h3 { font-weight: bold; margin-top: 10px; }
        .text-green { color: #10b981; } .text-red { color: #ef4444; } .text-blue { color: #3b82f6; }
        .tx-item { background: #1e293b; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #374151; }
        #login-section { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #020617; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="login-section">
        <div class="custom-panel text-center" style="width: 400px;">
            <h3 class="mb-4">–ñ“Ø–π–µ–≥–µ –∫—ñ—Ä—É</h3>
            <input type="email" id="email" class="form-control mb-3" placeholder="Email" value="admin@test.kz">
            <input type="password" id="password" class="form-control mb-4" placeholder="–ü–∞—Ä–æ–ª—å" value="123">
            <button onclick="login()" class="btn-add">–ö—ñ—Ä—É</button>
            <p onclick="document.getElementById('reg-part').style.display='block'" style="cursor:pointer; margin-top:10px; color:#9ca3af;">–¢—ñ—Ä–∫–µ–ª—É</p>
            <div id="reg-part" style="display:none;">
                <input type="text" id="reg-name" class="form-control mb-2" placeholder="–ê—Ç—ã“£—ã–∑">
                <button onclick="register()" class="btn btn-outline-light w-100">–¢—ñ—Ä–∫–µ–ª—É</button>
            </div>
        </div>
    </div>

    <div id="app-section" class="container-fluid p-4" style="display: none;">
        <div class="d-flex justify-content-between mb-4">
            <h4>üí∞ “ö–∞—Ä–∂—ã –ë–∞“õ—ã–ª–∞—É</h4>
            <button onclick="logout()" class="btn btn-sm btn-danger">–®—ã“ì—É</button>
        </div>

        <div class="row g-4">
            <div class="col-lg-4">
                <div class="custom-panel">
                    <h5 class="mb-4">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è “õ–æ—Å—É</h5>
                    <div class="type-toggle">
                        <button id="btn-expense" class="type-btn active-expense" onclick="setType('expense')">–®—ã“ì—ã–Ω</button>
                        <button id="btn-income" class="type-btn" onclick="setType('income')">–¢”©–ª–µ–º</button>
                    </div>
                    <input type="number" id="amount" class="form-control mb-3" placeholder="–°–æ–º–∞">
                    <div id="cat-wrapper">
                        <select id="cat-id" class="form-select mb-3">
                            <option value="1">üçî –¢–∞–º–∞“õ</option><option value="2">üöå –ö”©–ª—ñ–∫</option>
                            <option value="3">üõçÔ∏è –°–∞—Ç—ã–ø –∞–ª—É</option><option value="5">üí° –ö–æ–º–º—É–Ω–∞–ª–¥—ã“õ</option>
                            <option value="6">üíä –î–µ–Ω—Å–∞—É–ª—ã“õ</option><option value="9">üì¶ –ë–∞—Å“õ–∞</option>
                        </select>
                    </div>
                    <input type="date" id="date" class="form-control mb-3">
                    <input type="text" id="desc" class="form-control mb-3" placeholder="–°–∏–ø–∞—Ç—Ç–∞–º–∞">
                    <button onclick="addTransaction()" class="btn-add">“ö–æ—Å—É</button>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="row g-3 mb-4">
                    <div class="col-md-4"><div class="stat-card"><small>–ö—ñ—Ä—ñ—Å</small><h3 id="inc-val" class="text-green">0 ‚Ç∏</h3></div></div>
                    <div class="col-md-4"><div class="stat-card"><small>–®—ã“ì—ã—Å</small><h3 id="exp-val" class="text-red">0 ‚Ç∏</h3></div></div>
                    <div class="col-md-4"><div class="stat-card"><small>–ë–∞–ª–∞–Ω—Å</small><h3 id="net-val" class="text-blue">0 ‚Ç∏</h3></div></div>
                </div>

                <div class="custom-panel mb-4">
                    <h5>–ì—Ä–∞—Ñ–∏–∫ (–¢”©–ª–µ–º vs –®—ã“ì—ã—Å)</h5>
                    <div style="height: 250px;"><canvas id="barChart"></canvas></div>
                </div>

                <div class="custom-panel">
                    <h5>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–ª–∞—Ä —Ç–∞—Ä–∏—Ö—ã</h5>
                    <div id="tx-list" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://expense-tracker-api-iy65.onrender.com";
        let token = localStorage.getItem("token");
        let currentType = 'expense';

        document.getElementById('date').valueAsDate = new Date();
        if(token) showApp();

        function setType(t) {
            currentType = t;
            document.getElementById('btn-expense').className = t==='expense' ? 'type-btn active-expense' : 'type-btn';
            document.getElementById('btn-income').className = t==='income' ? 'type-btn active-income' : 'type-btn';
            document.getElementById('cat-wrapper').style.display = t==='expense' ? 'block' : 'none';
        }

        async function login() {
            const fd = new FormData();
            fd.append("username", document.getElementById('email').value);
            fd.append("password", document.getElementById('password').value);
            try {
                const res = await fetch(`${API_URL}/token`, { method: "POST", body: fd });
                if(!res.ok) throw new Error();
                const data = await res.json();
                localStorage.setItem("token", data.access_token);
                token = data.access_token;
                showApp();
            } catch { alert("–õ–æ–≥–∏–Ω “õ–∞—Ç–µ! –ù–µ–º–µ—Å–µ —Ç—ñ—Ä–∫–µ–ª—ñ“£—ñ–∑."); }
        }

        async function register() {
            const u = document.getElementById('reg-name').value;
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            await fetch(`${API_URL}/users/`, { 
                method: "POST", 
                headers: {"Content-Type":"application/json"}, 
                body: JSON.stringify({username:u, email:e, password:p}) 
            });
            alert("–¢—ñ—Ä–∫–µ–ª–¥—ñ! –ï–Ω–¥—ñ –ö–Ü–†–£ –±–∞—Å—ã“£—ã–∑.");
        }

        function logout() { localStorage.removeItem("token"); location.reload(); }
        function showApp() { 
            document.getElementById('login-section').style.display='none'; 
            document.getElementById('app-section').style.display='block'; 
            loadData(); 
        }

        async function loadData() {
            try {
                const headers = { "Authorization": `Bearer ${token}` };
                // –ë–∞–ª–∞–Ω—Å
                const balRes = await fetch(`${API_URL}/balance/`, { headers });
                const bal = await balRes.json();
                document.getElementById('inc-val').innerText = bal.total_income + " ‚Ç∏";
                document.getElementById('exp-val').innerText = bal.total_expenses + " ‚Ç∏";
                document.getElementById('net-val').innerText = bal.net_balance + " ‚Ç∏";

                // –¢—ñ–∑—ñ–º –∂”ô–Ω–µ –ì—Ä–∞—Ñ–∏–∫
                const [expRes, incRes] = await Promise.all([
                    fetch(`${API_URL}/expenses/`, { headers }),
                    fetch(`${API_URL}/incomes/`, { headers })
                ]);
                const exp = await expRes.json();
                const inc = await incRes.json();
                
                const all = [...exp.map(x=>({...x, type:'exp'})), ...inc.map(x=>({...x, type:'inc'}))];
                all.sort((a,b) => new Date(b.date) - new Date(a.date));

                renderList(all);
                drawChart(bal.total_income, bal.total_expenses);
            } catch(e) { console.error(e); }
        }

        async function addTransaction() {
            const amt = document.getElementById('amount').value;
            if(!amt) return alert("–°–æ–º–∞–Ω—ã –∂–∞–∑!");
            
            const body = {
                amount: parseFloat(amt),
                description: document.getElementById('desc').value,
                date: document.getElementById('date').value
            };
            if(currentType === 'expense') body.category_id = parseInt(document.getElementById('cat-id').value);

            const res = await fetch(`${API_URL}/${currentType}s/`, {
                method: "POST",
                headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });

            if(res.ok) {
                alert("–°”ô—Ç—Ç—ñ “õ–æ—Å—ã–ª–¥—ã!");
                loadData();
            } else {
                const err = await res.json();
                alert("“ö–∞—Ç–µ: " + JSON.stringify(err.detail));
            }
        }

        function renderList(data) {
            const list = document.getElementById('tx-list');
            list.innerHTML = "";
            data.forEach(i => {
                list.innerHTML += `
                    <div class="tx-item">
                        <div>
                            <div style="font-weight:bold; color:${i.type==='exp'?'#ef4444':'#10b981'}">
                                ${i.type==='exp'?'–®—ã“ì—ã–Ω':'–¢”©–ª–µ–º'}
                            </div>
                            <small style="color:#9ca3af">${i.description || '-'} | ${i.date.split('T')[0]}</small>
                        </div>
                        <div style="font-weight:bold; font-size:1.1rem;">${i.amount} ‚Ç∏</div>
                    </div>
                `;
            });
        }

        let myChart;
        function drawChart(inc, exp) {
            const ctx = document.getElementById('barChart');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['–ö—ñ—Ä—ñ—Å', '–®—ã“ì—ã—Å'],
                    datasets: [{
                        data: [inc, exp],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderRadius: 10
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }
    </script>
</body>
</html>